{% extends 'base.html' %}

{% block title %}Edit Profile - Sigma App{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl w-full space-y-8">
        <!-- Header -->
        <div>
            <h2 class="text-center text-4xl font-extrabold text-slate-100">
                Edit Profile
            </h2>
            <p class="mt-2 text-center text-sm text-slate-300">
                Update your profile information
            </p>
        </div>
        
        <!-- Edit Profile Form Card -->
        <div class="card-deep-sea">
            <form method="post" class="space-y-6">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- First Name -->
                    <div class="input-group">
                        <label for="{{ form.first_name.id_for_label }}" class="input-label">
                            First Name
                        </label>
                        {{ form.first_name }}
                        {% if form.first_name.errors %}
                            <div class="error-message">
                                {% for error in form.first_name.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Last Name -->
                    <div class="input-group">
                        <label for="{{ form.last_name.id_for_label }}" class="input-label">
                            Last Name
                        </label>
                        {{ form.last_name }}
                        {% if form.last_name.errors %}
                            <div class="error-message">
                                {% for error in form.last_name.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Email (Full Width) -->
                <div class="input-group">
                    <label for="{{ form.email.id_for_label }}" class="input-label">
                        Email Address
                    </label>
                    {{ form.email }}
                    {% if form.email.errors %}
                        <div class="error-message">
                            {% for error in form.email.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Full Name (auto-generated, read-only display) -->
                <div class="input-group">
                    <label class="input-label">
                        Display Name <span class="text-sm text-slate-300 font-normal">(Auto-generated)</span>
                    </label>
                    <div class="w-full px-4 py-3 border border-slate-600 rounded-lg bg-slate-700/50 text-slate-300">
                        <span id="display-name">{{ form.instance.full_name }}</span>
                    </div>
                    <p class="mt-1 text-sm text-slate-400">This is automatically generated from your first and last name.</p>
                </div>

                <!-- City (Full Width) -->
                <div class="input-group">
                    <label for="{{ form.city.id_for_label }}" class="input-label">
                        City
                    </label>
                    {{ form.city }}
                    {% if form.city.errors %}
                        <div class="error-message">
                            {% for error in form.city.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Profile Image URL (Full Width) -->
                <div class="input-group">
                    <label for="{{ form.profile_image_url.id_for_label }}" class="input-label">
                        Profile Image URL <span class="text-sm text-slate-300 font-normal">(Optional)</span>
                    </label>
                    {{ form.profile_image_url }}
                    {% if form.profile_image_url.errors %}
                        <div class="error-message">
                            {% for error in form.profile_image_url.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <p class="mt-1 text-sm text-slate-400">Enter a URL to your profile image. Leave blank to use default avatar.</p>

                    <!-- Image Preview -->
                    <div class="mt-3">
                        <div id="image-preview" class="hidden">
                            <p class="text-sm font-medium text-slate-300 mb-2">Preview:</p>
                            <img id="preview-img" src="" alt="Profile image preview"
                                 class="w-20 h-20 rounded-full object-cover border-2 border-slate-600"
                                 onerror="document.getElementById('image-preview').classList.add('hidden');">
                        </div>
                    </div>
                </div>

                <!-- Bio (Full Width) -->
                <div class="input-group">
                    <label for="{{ form.bio.id_for_label }}" class="input-label">
                        Bio <span class="text-sm text-slate-300 font-normal">(Optional)</span>
                    </label>
                    {{ form.bio }}
                    {% if form.bio.errors %}
                        <div class="error-message">
                            {% for error in form.bio.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <p class="mt-1 text-sm text-slate-400">Tell others about yourself and your sports interests.</p>
                </div>

                <!-- Action Buttons -->
                <div class="pt-4 flex flex-col sm:flex-row gap-3">
                    <button type="submit" class="btn btn-lg flex-1">
                        Save Changes
                    </button>
                    <a href="{% url 'authentication:profile' %}" class="btn btn-secondary btn-lg flex-1 text-center">
                        Cancel
                    </a>
                </div>

                <!-- Back to Profile Link -->
                <div class="text-center">
                    <a href="{% url 'authentication:profile' %}" 
                       class="text-sm font-medium text-gray-600 hover:text-gray-800 underline">
                        ‚Üê Back to Profile
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Choices.js on the city select field
        const citySelect = document.getElementById('{{ form.city.id_for_label }}');
        if (citySelect) {
            new Choices(citySelect, {
                searchEnabled: true,
                itemSelectText: '',
                searchPlaceholderValue: 'Search for a city...',
                noResultsText: 'No cities found',
                shouldSort: false
            });
        }

        // Update display name in real-time
        const firstNameField = document.getElementById('{{ form.first_name.id_for_label }}');
        const lastNameField = document.getElementById('{{ form.last_name.id_for_label }}');
        const displayNameSpan = document.getElementById('display-name');

        function updateDisplayName() {
            const firstName = firstNameField.value.trim();
            const lastName = lastNameField.value.trim();
            const displayName = firstName && lastName ? `${firstName} ${lastName}` : (firstName || lastName || 'Your Name');
            displayNameSpan.textContent = displayName;
        }

        firstNameField.addEventListener('input', updateDisplayName);
        lastNameField.addEventListener('input', updateDisplayName);

        // Image preview functionality
        const imageUrlField = document.getElementById('{{ form.profile_image_url.id_for_label }}');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');

        function updateImagePreview() {
            const url = imageUrlField.value.trim();
            if (url) {
                previewImg.src = url;
                imagePreview.classList.remove('hidden');
            } else {
                imagePreview.classList.add('hidden');
            }
        }

        // Show preview on page load if URL exists
        updateImagePreview();

        // Update preview when URL changes
        imageUrlField.addEventListener('input', updateImagePreview);
        imageUrlField.addEventListener('blur', updateImagePreview);
    });
</script>
{% endblock %}