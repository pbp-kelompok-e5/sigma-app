{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if is_own_connections %}My Connections{% else %}{{ target_user.username }}'s Friends{% endif %} - Sigma App
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                {% if is_own_connections %}
                    My Connections
                {% else %}
                    {{ target_user.username }}'s Friends
                {% endif %}
            </h1>
            <p class="text-gray-600">
                {% if is_own_connections %}
                    Manage your friends and connection requests
                {% else %}
                    View {{ target_user.username }}'s friends
                {% endif %}
            </p>
        </div>

        <!-- Own Profile View with Tabs -->
        {% if is_own_connections %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <!-- Tabs Navigation -->
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px">
                    <button id="friends-tab" class="tab-button active py-4 px-6 text-sm font-medium border-b-2 border-blue-500 text-blue-600">
                        Friends
                        <span class="ml-2 bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full">{{ my_friends|length }}</span>
                    </button>
                    <button id="received-tab" class="tab-button py-4 px-6 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Received
                        <span class="ml-2 bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">{{ received_requests|length }}</span>
                    </button>
                    <button id="sent-tab" class="tab-button py-4 px-6 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Sent
                        <span class="ml-2 bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">{{ sent_requests|length }}</span>
                    </button>
                </nav>
            </div>

            <!-- Search Bar -->
            <div class="p-4 border-b border-gray-200">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Search by name or username..." 
                           class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <svg class="w-5 h-5 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Friends Tab -->
                <div id="friends-content" class="tab-content active">
                    {% if my_friends %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="friends-list">
                            {% for user in my_friends %}
                            <div class="user-card flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <img src="{{ user.profile.profile_image_url|default:'/static/images/default-avatar.png' }}" 
                                        alt="{{ user.profile.full_name }}" 
                                        class="w-10 h-10 rounded-full object-cover">
                                    <div>
                                        <h3 class="font-semibold text-gray-900">{{ user.profile.full_name }}</h3>
                                        <p class="text-sm text-gray-500">@{{ user.username }}</p>
                                    </div>
                                </div>
                                <button class="remove-btn px-3 py-1 text-sm text-red-600 border border-red-600 rounded hover:bg-red-50 transition-colors"
                                        data-user-id="{{ user.id }}">
                                    Remove
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <p>No friends yet. Start connecting with other users!</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Received Requests Tab -->
                <div id="received-content" class="tab-content hidden">
                    {% if received_requests %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="received-list">
                            {% for user in received_requests %}
                            <div class="user-card flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <img src="{{ user.profile.profile_image_url|default:'/static/images/default-avatar.png' }}" 
                                        alt="{{ user.profile.full_name }}" 
                                        class="w-10 h-10 rounded-full object-cover">
                                    <div>
                                        <h3 class="font-semibold text-gray-900">{{ user.profile.full_name }}</h3>
                                        <p class="text-sm text-gray-500">@{{ user.username }}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="accept-btn px-3 py-1 text-sm text-white bg-green-500 rounded hover:bg-green-600 transition-colors"
                                            data-user-id="{{ user.id }}">
                                        Accept
                                    </button>
                                    <button class="reject-btn px-3 py-1 text-sm text-red-600 border border-red-600 rounded hover:bg-red-50 transition-colors"
                                            data-user-id="{{ user.id }}">
                                        Decline
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <p>No pending received requests.</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Sent Requests Tab -->
                <div id="sent-content" class="tab-content hidden">
                    {% if sent_requests %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="sent-list">
                            {% for user in sent_requests %}
                            <div class="user-card flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <img src="{{ user.profile.profile_image_url|default:'/static/images/default-avatar.png' }}" 
                                        alt="{{ user.profile.full_name }}" 
                                        class="w-10 h-10 rounded-full object-cover">
                                    <div>
                                        <h3 class="font-semibold text-gray-900">{{ user.profile.full_name }}</h3>
                                        <p class="text-sm text-gray-500">@{{ user.username }}</p>
                                    </div>
                                </div>
                                <button class="cancel-btn px-3 py-1 text-sm text-gray-600 border border-gray-600 rounded hover:bg-gray-50 transition-colors"
                                        data-user-id="{{ user.id }}">
                                    Cancel
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <p>No pending sent requests.</p>
                        </div>
                    {% endif %}
                </div>

                
            </div>
        </div>

        <!-- Public View (Other User's Friends) -->
        {% else %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <!-- Search Bar -->
            <div class="p-4 border-b border-gray-200">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Search friends..." 
                           class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <svg class="w-5 h-5 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>

            <!-- Friends List -->
            <div class="p-6">
                {% if friends %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="friends-list">
                        {% for user in friends %}
                        <div class="user-card flex items-center p-4 border border-gray-200 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <img src="{{ user.to_user.profile_image_url|default:'/static/images/default-avatar.png' }}" 
                                     alt="{{ user.profile.full_name }}" 
                                     class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <h3 class="font-semibold text-gray-900">{{ user.profile.full_name }}</h3>
                                    <p class="text-sm text-gray-500">@{{ user.username }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <p>{{ target_user.username }} doesn't have any friends yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Tab Switching
document.addEventListener('DOMContentLoaded', function() {
    // Tab functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const target = this.id.replace('-tab', '-content');
            
            // Update buttons
            tabButtons.forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            this.classList.add('active', 'border-blue-500', 'text-blue-600');
            this.classList.remove('border-transparent', 'text-gray-500');
            
            // Update contents
            tabContents.forEach(content => content.classList.add('hidden'));
            document.getElementById(target).classList.remove('hidden');
        });
    });

    // Search functionality
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const activeTab = document.querySelector('.tab-content:not(.hidden)');
            const userCards = activeTab.querySelectorAll('.user-card');
            
            userCards.forEach(card => {
                const userName = card.querySelector('h3').textContent.toLowerCase();
                const userUsername = card.querySelector('p').textContent.toLowerCase();
                
                if (userName.includes(searchTerm) || userUsername.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }

    const isOwnConnections = "{{ is_own_connections }}" === "True";

    if (isOwnConnections) {
        const contentContainer = document.querySelector('.bg-white.rounded-xl .p-6');

        if (contentContainer) {
            contentContainer.addEventListener('click', function(event) {
                const target = event.target.closest('button'); // button yang diklik

                if (!target) return;

                let actionType = null;

                const userId = target.dataset.userId;

                if (target.classList.contains('accept-btn')) {
                    actionType = 'accept';
                } else if (target.classList.contains('reject-btn')) {
                    actionType = 'reject';
                } else if (target.classList.contains('remove-btn')) {
                    actionType = 'remove';
                } else if (target.classList.contains('cancel-btn')) {
                    actionType = 'cancel';
                }

                // jalankan action sesuai tipe
                if (actionType && userId) {
                    handleConnectionAction(actionType, userId, target);
                }
            });
        }
        // initializeConnectionActions();
    }
});

// harusnya udah gak perlu ini karena pake event delegation di atas
// pisahin function connection actions
function initializeConnectionActions() {
    // Accept request
    document.querySelectorAll('.accept-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            handleConnectionAction('accept', this.dataset.userId, this);
        });
    });

    // Reject request
    document.querySelectorAll('.reject-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            handleConnectionAction('reject', this.dataset.userId, this);
        });
    });

    // Remove friend
    document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            handleConnectionAction('remove', this.dataset.userId, this);
        });
    });

    // Cancel sent request
    document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            handleConnectionAction('cancel', this.dataset.userId, this);
        });
    });
}

function handleConnectionAction(action, userId, button) {
    console.log(`Action: ${action}, User ID: ${userId}`);
    
    if (!confirm(`Are you sure you want to ${action} this connection?`)) {
        return;
    }

    button.disabled = true;
    button.textContent = 'Processing...';

    // Debug URL
    const url = `/matching/connection/${action}/user/${userId}/`;
    console.log('Fetching URL:', url);

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {

            const cardRemove = button.closest('.user-card');

            if (action === 'accept') {
                const photo = cardRemove.querySelector('img').src;
                const fullName = cardRemove.querySelector('h3').textContent;
                const username = cardRemove.querySelector('p').textContent;

                const friendCard = `
                <div class="user-card flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <img src="${photo}" 
                            alt="${fullName}" 
                            class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <h3 class="font-semibold text-gray-900">${fullName}</h3>
                            <p class="text-sm text-gray-500">${username}</p>
                        </div>
                    </div>
                    <button class="remove-btn px-3 py-1 text-sm text-red-600 border border-red-600 rounded hover:bg-red-50 transition-colors"
                            data-user-id="${userId}">
                        Remove
                    </button>
                </div>
                `;

                const friendsTabContent = document.getElementById('friends-content');

                let friendsListContainer = friendsTabContent.querySelector('#friends-list');

                if (!friendsListContainer) {
                    friendsListContainer = document.createElement('div');
                    friendsListContainer.id = 'friends-list';
                    friendsListContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                    friendsTabContent.innerHTML = '';
                    friendsTabContent.appendChild(friendsListContainer);
                }

                friendsListContainer.insertAdjacentHTML('beforeend', friendCard);

                // add card to friends list in the friends tab in position before the "no friends" message if it exists
                // document.getElementById('friends-list').insertAdjacentHTML('beforeend', friendCard);
            }
            cardRemove.remove();
            showNotification('Action successful!', 'success');
            updateTabCounters(action);
        } else {
            alert('Error: ' + data.error);
            button.disabled = false;
            button.textContent = getOriginalButtonText(action);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred: ' + error.message);
        button.disabled = false;
        button.textContent = getOriginalButtonText(action);
    });
}

function getOriginalButtonText(action) {
    const texts = {
        'accept': 'Accept',
        'reject': 'Decline', 
        'remove': 'Remove',
        'cancel': 'Cancel'
    };
    return texts[action];
}

function updateTabCounters(action) {
    const friendsTab = document.querySelector('#friends-tab span'); // fix selector
    
    if (action === 'accept') {
        // increment friends, decrement received
        let currentFriends = parseInt(friendsTab.textContent, 10); // convert to int
        friendsTab.textContent = currentFriends + 1;
    } else {
        const friendList = document.getElementById('friends-list');
        const friendCount = friendList ? friendList.querySelectorAll('.user-card').length : 0;
        friendsTab.textContent = friendCount;
    }

    const receivedList = document.getElementById('received-list');
    const receivedCount = receivedList ? receivedList.querySelectorAll('.user-card').length : 0;
    const receivedTab = document.querySelector('#received-tab span');

    if (receivedTab) {
        receivedTab.textContent = receivedCount;
    }

    const sentList = document.getElementById('sent-list');
    const sentCount = sentList ? sentList.querySelectorAll('.user-card').length : 0;
    const sentTab = document.querySelector('#sent-tab span');

    if (sentTab) {
        sentTab.textContent = sentCount;
    }

    // debug output
    console.log(`Tab counters updated after '${action}' action.`);
}

function showNotification(message, type = 'info') {
    const bgColor = type === 'success' ? 'bg-green-500' : 
                   type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}