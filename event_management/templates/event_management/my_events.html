{% extends "base.html" %}
{% block title %}My Events{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto mt-8">
    <h1 class="text-2xl font-semibold text-white mb-6">My Events</h1>

    <!-- Upcoming Events -->
    <h2 class="text-xl text-gray-200 mb-3">Upcoming Events</h2>
    {% for event in upcoming_events %}
    <div class="bg-gray-900 p-4 mb-4 rounded-lg shadow-md flex justify-between items-center event-item" data-event-id="{{ event.id }}">
        <div>
            <h2 class="text-lg font-bold text-white">{{ event.name }}</h2>
            <p class="text-gray-400">{{ event.event_date }}</p>
            <p class="text-gray-400">Status: {{ event.status }}</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'event_management:update_event' event.id %}"
               class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Edit</a>
            <button data-event-id="{{ event.id }}"
                    class="cancel-btn bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded">
                Cancel
            </button>
            <button data-event-id="{{ event.id }}"
                    class="delete-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">
                Delete
            </button>
        </div>
    </div>
    {% empty %}
    <p class="text-gray-400 mb-6">You have no upcoming events.</p>
    {% endfor %}

    <!-- Past Events -->
    <h2 class="text-xl text-gray-200 mt-8 mb-3">Past Events</h2>
    {% for event in past_events %}
    <div class="bg-gray-900 p-4 mb-4 rounded-lg shadow-md flex justify-between items-center">
        <div>
            <h2 class="text-lg font-bold text-white">{{ event.name }}</h2>
            <p class="text-gray-400">{{ event.event_date }}</p>
            <p class="text-gray-400">Status: {{ event.status }}</p>
        </div>
        <a href="{% url 'event_management:update_event' event.id %}"
           class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">View</a>
    </div>
    {% empty %}
    <p class="text-gray-400">You have no past events.</p>
    {% endfor %}
</div>

{% include "components/modal.html" %}
{% endblock %}

{% block extra_js %}
<script>
// === DELETE EVENT ===
document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const eventId = btn.dataset.eventId;
        openModal("Delete Event", "Are you sure you want to permanently delete this event?", async () => {
            try {
                const res = await ajaxDelete(`/event_management/${eventId}/delete/`);
                if (res.success) {
                    showSuccessToast(res.message);
                    document.querySelector(`.event-item[data-event-id="${eventId}"]`).remove();
                } else {
                    showErrorToast(res.message || "Failed to delete event.");
                }
            } catch (err) {
                handleAjaxError(err);
            }
        });
    });
});

// === CANCEL EVENT ===
document.querySelectorAll(".cancel-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const eventId = btn.dataset.eventId;
        openModal("Cancel Event", "Are you sure you want to cancel this event? It will no longer be open for participants.", async () => {
            try {
                const res = await ajaxPatch(`/event_management/${eventId}/cancel/`);
                if (res.success) {
                    showInfoToast(res.message);
                    // Update the event cardâ€™s status text dynamically
                    const card = document.querySelector(`.event-item[data-event-id="${eventId}"]`);
                    if (card) {
                        const statusEl = card.querySelector("p.text-gray-400:nth-child(3)");
                        if (statusEl) statusEl.textContent = "Status: cancelled";
                    }
                } else {
                    showErrorToast(res.message || "Failed to cancel event.");
                }
            } catch (err) {
                handleAjaxError(err);
            }
        });
    });
});
</script>
{% endblock %}
