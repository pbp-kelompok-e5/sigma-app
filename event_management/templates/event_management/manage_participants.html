{% extends "base.html" %}
{% block title %}Manage Participants{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto mt-8">
    <h1 class="text-2xl font-semibold text-white mb-6">Manage Participants - {{ event.name }}</h1>

    <table class="min-w-full bg-gray-900 rounded-lg overflow-hidden text-white">
        <thead class="bg-gray-800">
            <tr>
                <th class="py-2 px-4 text-left">Name</th>
                <th class="py-2 px-4 text-left">Status</th>
                <th class="py-2 px-4 text-right">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for p in participants %}
            <tr class="border-b border-gray-700" id="participant-{{ p.user.id }}">
                <td class="py-2 px-4">{{ p.user.username }}</td>
                <td class="py-2 px-4">{{ p.status }}</td>
                <td class="py-2 px-4 text-right space-x-2">
                    <button data-user-id="{{ p.user.id }}" 
                            data-action="mark_attended" 
                            class="mark-btn bg-green-600 hover:bg-green-700 px-3 py-1 rounded">Mark Attended</button>
                    <button data-user-id="{{ p.user.id }}" 
                            data-action="remove" 
                            class="remove-btn bg-red-600 hover:bg-red-700 px-3 py-1 rounded">Remove</button>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="py-4 text-center text-gray-400">No participants.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% include "components/modal.html" %}
{% endblock %}

{% block extra_js %}
<script>
function handleParticipantAction(button) {
    const userId = button.dataset.userId;
    const action = button.dataset.action;
    const eventId = "{{ event.id }}";

    const message = action === "remove"
        ? "Are you sure you want to remove this participant?"
        : "Mark this participant as attended?";

    openModal("Confirm Action", message, async () => {
        try {
            const res = await ajaxPost(`/event_management/${eventId}/participants/`, {
                action: action,
                user_id: userId
            });
            if (res.success) {
                showSuccessToast(res.message);
                if (action === "remove") {
                    document.getElementById(`participant-${userId}`).remove();
                } else if (action === "mark_attended") {
                    document.querySelector(`#participant-${userId} td:nth-child(2)`).innerText = "attended";
                }
            } else {
                showErrorToast(res.message || "Failed to perform action.");
            }
        } catch (err) {
            handleAjaxError(err);
        }
    });
}

document.querySelectorAll(".mark-btn, .remove-btn").forEach(btn => {
    btn.addEventListener("click", () => handleParticipantAction(btn));
});
</script>
{% endblock %}
