{% extends 'base.html' %}
{% load static %}
{% block title %}Edit Review{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/global.css' %}">

<div class="container mx-auto" style="max-width: 600px; padding: 40px 16px;">
  <div class="card-deep-sea">

    <!-- Header -->
    <div class="card-header">
      Edit Review for: {{ review.to_user.username }} <br/>
      <span class="text-md">Event: {{ review.event.title }}</span>
    </div>

    <div class="card-body" style="text-align:center;">

      <form id="editReviewForm">
        {% csrf_token %}

        <!-- STAR RATING -->
        <div class="flex justify-center gap-1 rating-stars mb-6" data-review="{{ review.id }}">
          {% for i in "12345" %}
            <button type="button"
              class="star-btn text-[--orange-sport] transition text-4xl"
              data-value="{{ forloop.counter }}">☆
            </button>
          {% endfor %}
          <input type="hidden" name="rating" value="{{ review.rating }}">
        </div>

        <!-- COMMENT -->
        <div class="input-group" style="text-align:left; margin-bottom: 24px;">
          <label class="input-label">Comment</label>
          <textarea name="comment" rows="4">{{ review.comment }}</textarea>
        </div>

        <!-- Buttons -->
        <div class="card-footer" style="margin-top: 10px; display:flex; gap:10px;">
          <button id="saveBtn" type="button" class="btn btn-primary btn-full">Save Changes</button>

          <a href="{% url 'reviews:user-written-reviews' request.user.id %}" 
             class="btn btn-secondary btn-full">
            Cancel
          </a>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container" class="fixed top-5 right-5 z-50"></div>

<!-- STAR + AJAX SCRIPT -->
<script>
// CSRF helper
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
const CSRF_TOKEN = getCookie('csrftoken');

// STAR LOGIC
document.querySelectorAll('.rating-stars').forEach(container => {
  const hiddenInput = container.querySelector('input[name="rating"]');
  const stars = container.querySelectorAll('.star-btn');
  let selectedRating = hiddenInput.value || 0;

  function renderStars(rating) {
    stars.forEach(s => {
      if (s.dataset.value <= rating) {
        s.textContent = '★';
      } else {
        s.textContent = '☆';
      }
    });
  }

  stars.forEach(star => {
    star.addEventListener('mouseenter', () => renderStars(star.dataset.value));
    star.addEventListener('mouseleave', () => renderStars(selectedRating));
    star.addEventListener('click', () => {
      selectedRating = star.dataset.value;
      hiddenInput.value = selectedRating;
      renderStars(selectedRating);
    });
  });

  renderStars(selectedRating);
});

// AJAX UPDATE SUBMIT
document.getElementById('saveBtn')?.addEventListener('click', async () => {
  const rating = document.querySelector('input[name="rating"]').value;
  const comment = document.querySelector('textarea[name="comment"]').value;
  const reviewId = "{{ review.id }}";

  if (!rating) {
    showToast('Please select a rating.', 'error');
    return;
  }

  const form = new FormData();
  form.append('rating', rating);
  form.append('comment', comment || 'No comment');

  try {
    const res = await fetch(`/reviews/ajax/review/${reviewId}/update/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF_TOKEN },
      body: form
    });

    const data = await res.json();

    if (data.ok) {
      showToast('Review updated!', 'success');

      // redirect back to written reviews page
      setTimeout(() => {
        window.location.href = "{% url 'reviews:user-written-reviews' request.user.id %}";
      }, 800);

    } else {
      showToast(data.error || 'Update failed.', 'error');
    }

  } catch (e) {
    showToast('Network error.', 'error');
  }
});

// Toast
function showToast(msg, type='success') {
  const wrap = document.createElement('div');
  wrap.className = `px-4 py-3 rounded-lg shadow-lg text-white mb-3 ${
    type === 'success' ? 'bg-green-600' : 'bg-red-600'
  }`;
  wrap.innerText = msg;
  document.getElementById('toast-container').appendChild(wrap);
  setTimeout(() => wrap.remove(), 2300);
}
</script>

{% endblock %}
