{% extends 'base.html' %}
{% load static %}
{% block title %}Review - Sigma App{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/global.css' %}">

<div class="container mx-auto" style="max-width: 1100px; padding: 40px 16px;">
  <div class="card-deep-sea">
    <div class="flex justify-center">
      <h1 class="text-[--orange-sport] my-2" style="font-size: 1.5rem;">
        <span class="text-4xl font-bold">{{ event.title }}</span> - submit reviews
      </h1>
    </div>

    <div class="card-body">
      <form method="POST" class="space-y-6">
        {% csrf_token %}
        {% if participants %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-16 m-10">
          {% for user in participants %}
          <div class="card-deep-sea" style="background-color: var(--deep-sea-light); padding: 20px; text-align:center;">

            <img
              src="{{ user.profile.profile_image_url|default:'https://ui-avatars.com/api/?name='|add:user.username }}"
              alt="{{ user.username }}"
              class="w-20 h-20 rounded-full object-cover border-2 border-slate-600 inline-block mb-2"
            >

            <div class="card-header" style="font-size: 1.25rem; margin-bottom: 10px;">
              {{ user.username }}
            </div>

            <div class="flex justify-center gap-1 rating-stars" data-user="{{ user.id }}" style="margin-bottom: 14px;">
              {% for i in "12345" %}
                <button type="button"
                  class="star-btn text-[--orange-sport] transition text-4xl"
                  data-value="{{ forloop.counter }}">☆</button>
              {% endfor %}
              <input type="hidden" name="rating_{{ user.id }}" />
            </div>

            <div class="input-group" style="margin-top: 12px; text-align:left; width: 100%;">
              <textarea name="comment_{{ user.id }}" placeholder="(Optional) Write your comment..."></textarea>
            </div>

          </div>
          {% endfor %}
        </div>
        {% endif %}

        <div class="card-footer" style="margin-top: 24px;">
          <button id="submit-btn" type="submit" class="btn btn-primary btn-full opacity-50 cursor-not-allowed mx-10 my-4" disabled>
            Submit All Reviews
          </button>
        </div>
      </form>
    </div>
  </div>

  <hr style="margin: 40px 0; border-color: rgba(255,255,255,0.1);" />

  <div class="card-deep-sea">
    <div class="card-header">All Reviews</div>
    <div class="card-body">
      {% for review in reviews %}
        <div style="background: var(--deep-sea-light); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
          <p><strong>{{ review.from_user.username }}</strong> → {{ review.to_user.username }}</p>
          <p style="color: var(--orange-sport); font-weight: 600;">{{ review.rating }} ⭐</p>
          <p><em>{{ review.comment }}</em></p>
          <p style="font-size: 0.875rem; opacity: 0.7;">{{ review.created_at }}</p>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ✅ STAR SCRIPT -->
<script>
document.querySelectorAll('.rating-stars').forEach(container => {
  const userId = container.dataset.user;
  const stars = container.querySelectorAll('.star-btn');
  const hiddenInput = container.querySelector(`input[name="rating_${userId}"]`);
  const submitBtn = document.getElementById('submit-btn');

  let selectedRating = 0;

  function renderStars(rating) {
    stars.forEach(s => {
      if (s.dataset.value <= rating) {
        s.textContent = '★'; // filled
        s.style.color = 'var(--orange-sport)';
      } else {
        s.textContent = '☆'; // outline
        s.style.color = 'var(--orange-sport)';
      }
    });
  }

  function checkAllRated() {
    const allFilled = [...document.querySelectorAll('.rating-stars')]
      .every(group => group.querySelector(`input[type="hidden"]`).value !== "");
    if (allFilled) {
      submitBtn.disabled = false;
      submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
    }
  }

  stars.forEach(star => {
    star.addEventListener('mouseenter', () => {
      renderStars(star.dataset.value);
    });

    star.addEventListener('mouseleave', () => {
      renderStars(selectedRating || 0);
    });

    star.addEventListener('click', () => {
      selectedRating = star.dataset.value;
      hiddenInput.value = selectedRating;
      renderStars(selectedRating);
      checkAllRated();
    });
  });

  renderStars(0);
});
</script>
{% endblock %}
