{% extends 'base.html' %}
{% load static %}
{% block title %}My Written Reviews - Sigma App{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/global.css' %}">

<div class="container mx-auto" style="max-width: 1000px; padding: 40px 16px;">
  <div class="card-deep-sea">
    <div class="card-header">
      Reviews written by: {{ writer.username }}
    </div>

    <div class="card-body">
      {% if reviews %}

      <!-- ✅ GRID 3 COLUMNS -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

        {% for review in reviews %}
        <div id="review-card-{{ review.id }}" style="background: var(--deep-sea-light); border-radius: 12px; padding: 16px;">

          <p><strong>You</strong> → {{ review.to_user.username }}</p>

          <p style="color: var(--orange-sport); font-weight: 600;">
            {{ review.rating }} ⭐
          </p>

          <p style="font-size: .9rem; opacity: .9;">
            Event: <span style="font-weight: 600;">{{ review.event.title }}</span>
          </p>

          <p><em>{{ review.comment }}</em></p>

          <p style="font-size: 0.75rem; opacity: 0.7; margin-top: 6px;">
            {{ review.created_at }}
          </p>

          <div class="flex gap-2 mt-4">
            <a href="{% url 'reviews:edit-review' review.id %}"
               class="btn btn-sm btn-secondary w-full">
              Edit
            </a>

            <button type="button"
              class="btn btn-sm btn-danger w-full"
              onclick="openDeleteModal('{{ review.id }}', '{{ review.event.title }}')">
              Delete
            </button>
          </div>
        </div>
        {% endfor %}

      </div>

      {% else %}
      <p style="opacity: 0.7; font-style: italic;">You haven't written any reviews yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- ✅ MODAL DELETE -->
<div id="deleteModal"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="card-deep-sea" style="max-width: 400px; padding: 24px; text-align:center;">
    <h3 class="card-header" id="modalEventName">Confirm Delete</h3>

    <p style="margin-top: 10px; opacity: .85;">
      Are you sure you want to delete this review?
    </p>

    <div class="card-footer" style="margin-top: 20px; display:flex; gap:12px;">
      <button id="confirmDeleteBtn" class="btn btn-danger btn-full">Delete</button>
      <button onclick="closeDeleteModal()" class="btn btn-secondary btn-full">Cancel</button>
    </div>

  </div>
</div>

<!-- ✅ TOAST CONTAINER -->
<div id="toast-container" class="fixed top-5 right-5 z-50"></div>

<!-- ✅ AJAX DELETE SCRIPT -->
<script>
// CSRF helper
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
const CSRF_TOKEN = getCookie('csrftoken');

let deleteTargetId = null;

function openDeleteModal(reviewId, eventTitle) {
  deleteTargetId = reviewId;
  document.getElementById('modalEventName').innerText = `Delete Review for: ${eventTitle}`;
  document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
  deleteTargetId = null;
  document.getElementById('deleteModal').classList.add('hidden');
}

document.getElementById('confirmDeleteBtn')?.addEventListener('click', async () => {
  if (!deleteTargetId) return;
  try {
    const res = await fetch(`/reviews/ajax/review/${deleteTargetId}/delete/`, {
      method: 'POST',
      headers: {'X-CSRFToken': CSRF_TOKEN},
    });
    const data = await res.json();
    if (data.ok) {
      const card = document.getElementById(`review-card-${deleteTargetId}`);
      if (card) card.remove();
      closeDeleteModal();
      showToast('Review deleted.', 'success');
    } else {
      showToast(data.error || 'Failed to delete review.', 'error');
    }
  } catch (e) {
    showToast('Network error.', 'error');
  }
});

function showToast(msg, type='success') {
  const wrap = document.createElement('div');
  wrap.className = `px-4 py-3 rounded-lg shadow-lg text-white mb-3 ${
    type === 'success' ? 'bg-green-600' : 'bg-red-600'
  }`;
  wrap.innerText = msg;
  document.getElementById('toast-container').appendChild(wrap);
  setTimeout(() => wrap.remove(), 2500);
}
</script>

{% endblock %}
