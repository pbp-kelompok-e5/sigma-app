{% extends "base.html" %}
{% load icon_tags %}
{% block title %}Events Discovery{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center gap-3 mb-2">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">Event Discovery</h1>
        </div>
        <p class="text-white/80 text-base sm:text-lg">Temukan event yang sesuai dengan minatmu</p>
    </div>

    <!-- Search And Filter -->
    <div class="card-deep-sea flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
        <input type="text" id="searchInput" placeholder="Search events..." class="w-full sm:w-1/2 p-3 rounded-lg bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#F26419]">

        <!-- Placeholder: TO BE REPLACED -->
        <select id="filterSelect" class="w-full sm:w-1/4 p-3 rounded-lg bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-[#F26419]">
            <option value="all">All Categories</option>
            <option value="technology">Technology</option>
            <option value="art">Art</option>
            <option value="music">Music</option>
            <option value="sports">Sports</option>
        </select>
    </div>

    <!-- Loading State -->
     <div id="loading" class="bg-[#00063D] rounded-lg border border-gray-800 p-12 text-center hidden">
      <svg class="animate-spin h-8 w-8 text-[#F26419] inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-white mt-3">Loading Events...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden"></div>

    <!-- Events Grid -->
    <div id='grid' class="hidden"></div>
    
    <!-- Empty State -->
    <div id="empty" class="card-deep-sea text-center text-white">
        <h3 class="text-lg font-medium font-bold mb-2">Tidak ada event yang berlangsung</h3>
        <p>Cek kembali untuk menemukan event seru lainnya!</p>     
    </div>
    
</div>

<script>
    const Event_API_URL = "{% url 'event_discovery:show_json' %}";
    const CURRENT_USER_ID = "{{ user.id|default_if_none:"" }}";

    // DOM Elements
    const gridContainer = document.getElementById('grid');
    const loadingIndicator = document.getElementById('loading');
    const errorContainer = document.getElementById('error');
    const emptyState = document.getElementById('empty');
  
    let allEvents = []; // To store all fetched events
    let activeFilter = 'all'

    // Function to display different sections
    function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
        loadingIndicator.classList.toggle('hidden', !showLoading); 
        errorContainer.classList.toggle('hidden', !showError);
        emptyState.classList.toggle('hidden', !showEmpty);
        gridContainer.classList.toggle('hidden', !showGrid);

        // Add Grid Class when showing grid
        if (showGrid) {
            gridContainer.classList.add('grid', 'grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'gap-6');
        }
    }

    // Filtered Events
    function filteredEvents(){
        let filteredEvents;
        // Add Filter Logic TODO
        if (activeFilter == 'all') {
            filteredEvents = allEvents
        }

        if (filteredEvents.length === 0) {
            displayPageSection({ showEmpty: true });
        } else {
            displayPageSection({ showGrid: true });
        }
    }


    // Fetch Events from API
    async function fetchEvents() {
        try{
            displayPageSection({ showLoading: true });

            const response = await fetch(Event_API_URL, {
                headers: {
                    'Accept': 'application/json'
                }
            }); 
            if (!response.ok) {
                throw new Error('Failed to fetch events');
            }
            const events = await response.json();
            allEvents = events || []; // Store fetched events

            // Call Filter and Render after fetching
            filteredEvents();

        }
        catch (error) {
            // Show Error Message
            // To be Changed
            errorContainer.innerHTML = `<div class="card-deep-sea p-4 text-red-500">Error loading events. Please try again later.</div>`; // TODO
            console.error('Error fetching events:', error);
            displayPageSection({ showError: true });
        }
    }

    function InitializeEventPage() {

        // Fetch Events on Page Load
        fetchEvents();
    }

    InitializeEventPage();
</script>

{% endblock content %}